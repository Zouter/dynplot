---
output: md_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup1, include=FALSE}
knitr::opts_chunk$set(fig.path=".readme_files/", warning=FALSE, message=FALSE, error=FALSE, echo = TRUE)
```

# dynplot

**dynplot** provides common functionality for plotting trajectories.

[![Build Status](https://travis-ci.org/dynverse/dynplot.svg)](https://travis-ci.org/dynverse/dynplot)
[![codecov](https://codecov.io/gh/dynverse/dynplot/branch/master/graph/badge.svg)](https://codecov.io/gh/dynverse/dynplot)

The package provides different ways to plot both the topology and cellular properties of a trajectory:

```{r}
library(dplyr)
library(dyntoy)
library(dynplot)
library(dynutils)
library(dynwrap)
library(tidyverse)

library(patchwork)

traj <- toy_tasks %>% filter(id == "toy/consecutive_bifurcating_1") %>% extract_row_to_list(1)
traj <- traj %>% root_trajectory()
grouping_assignment <- traj$prior_information$grouping_assignment
groups <- tibble(group_id = unique(grouping_assignment$group_id)) %>% mutate(color=dynplot:::milestone_palette_list$auto(n()))
features_oi <- apply(traj$counts, 2, sd) %>% sort() %>% names() %>% tail(10)
feature_oi <- features_oi[[1]]
```


```{r cells, fig.width=15, fig.height=10, echo=FALSE}
empty <- ggplot() + theme_void()
question <- empty + geom_text(aes(0, 0, label="????"))
unavailable <- empty + geom_text(aes(0, 0, label="----"))

title <- list(
  dynplot:::empty_plot(), 
  # empty + geom_label(aes(0, 0, label="Topology")),
  empty + geom_label(aes(0, 0, label="Ordering")),
  empty + geom_label(aes(0, 0, label="Grouping/clustering")),
  empty + geom_label(aes(0, 0, label="Expression of \n a single gene")), 
  empty + geom_label(aes(0, 0, label="Pseudotime"))
)

dendro <- list(
  empty + geom_label(aes(0, 0, label="Dendrogram")),
  # plot_dendro(traj),
  plot_dendro(traj, "milestone"),
  plot_dendro(traj, grouping_assignment=grouping_assignment, groups=groups),
  plot_dendro(traj, feature_oi=feature_oi),
  plot_dendro(traj, "pseudotime")
)

onedim <- list(
    empty + geom_label(aes(0, 0, label="Onedim")),
    # plot_onedim(traj),
    plot_onedim(traj, "milestone"),
    plot_onedim(traj, grouping_assignment=grouping_assignment, groups=groups),
    plot_onedim(traj, feature_oi=feature_oi),
    plot_onedim(traj, "pseudotime")
  )

graph <- list(
  empty + geom_label(aes(0, 0, label="Graph")),
  # plot_graph(traj),
  plot_graph(traj, "milestone"),
  plot_graph(traj, grouping_assignment=grouping_assignment, groups=groups),
  plot_graph(traj, feature_oi=feature_oi),
  plot_graph(traj, "pseudotime")
)

dimred <- list(
  empty + geom_label(aes(0, 0, label="Dimensionality reduction")),
  # plot_dimred(traj),
  plot_dimred(traj, "milestone"),
  plot_dimred(traj, grouping_assignment=grouping_assignment, groups=groups),
  plot_dimred(traj, feature_oi=feature_oi),
  plot_dimred(traj, "pseudotime")
)

wrap_plots(
  c(title, dendro, onedim, graph, dimred),
  nrow=5,
  byrow=TRUE
) & theme(legend.position = "none")

```


And to plot the expression and feature importances of many genes along the trajectory

```{r heatmap, echo=FALSE, fig.width=10, fig.height=6}
cell_feature_importance <- dynfeature::calculate_cell_feature_importance(traj %>% dynwrap::add_waypoints_to_wrapper())
plot_heatmap(traj, cell_feature_importance=cell_feature_importance, grouping_assignment = traj$prior_information$grouping_assignment)
```

