#' Default theme for TI plots
#'
#' @param g A ggplot to modify
#' @param id The title
#' @param expand Whether or not to leave space at the borders
#'
#' @export
process_dynplot <- function(g, id, expand = TRUE) {
  ranges <- ggplot_build(g)$layout$panel_ranges[[1]]
  yrange <- ranges$y.range
  xrange <- ranges$x.range

  xdiff <- diff(xrange)
  ydiff <- diff(yrange)
  maxdiff <- max(xdiff, ydiff)
  new_xrange <- mean(xrange) + c(-maxdiff/2, maxdiff/2)
  new_yrange <- mean(yrange) + c(-maxdiff/2, maxdiff/2)
  new_xrange2 <- mean(xrange) + c(-maxdiff, maxdiff)
  new_yrange2 <- mean(yrange) + c(-maxdiff, maxdiff)

  g +
    theme(
      plot.title = element_text(size = 20, face = "bold", hjust = .5),
      panel.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      panel.border = element_rect(colour = "black", fill=NA),
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      legend.key = element_blank()
    ) +
    ggtitle(id) +
    coord_equal(expand = expand, xlim = new_xrange, ylim = new_yrange) +
    xlim(new_xrange2[[1]], new_xrange2[[2]]) + ylim(new_yrange2[[1]], new_yrange2[[2]]) +
    expand_limits(x = new_xrange, y = new_yrange)
}

#' Plot a dimensionality reduced trajectory
#'
#' @param object output as generated by \code{\link{dimred_trajectory}} or \code{\link[dynwrap]{wrap_data}}
#' @param insert_phantom_edges attempt to plot bifurcating edges correctly automatically
#' @param line_size size of the line
#' @param arrow_length length of the arrow
#' @param label what to label: the leaves, all nodes or none
#' @param plot_milestones whether to plot the milestones
#'
#' @importFrom grid arrow
#' @importFrom cowplot theme_cowplot
#' @importFrom ggrepel geom_label_repel
#'
#' @export
plot_default <- function(
  object,
  insert_phantom_edges = TRUE,
  line_size = 8,
  arrow_length = unit(1, "cm"),
  label = c("leaves", "all", "none"),
  plot_milestones = TRUE
) {
  dimred_object <- check_or_perform_dimred(object, insert_phantom_edges)

  label <- match.arg(label)

  nodes_to_label <-
    if (label == "leaves") {
      dimred_object$space_lines %>% {c(setdiff(.$from, .$to), setdiff(.$to, .$from))}
    } else if (label == "all") {
      dimred_object$space_milestones$milestone_id
    } else if (label == "none"){
      c()
    } else {
      stop(sQuote("label"), " should be one of: \"leaves\", \"all\", or \"none\"")
    }

  g <-
    ggplot() +
    theme(legend.position = "none") +
    geom_segment(
      aes(x = from.Comp1, xend = from.Comp1 + (to.Comp1 - from.Comp1) / 2, y = from.Comp2, yend = from.Comp2 + (to.Comp2 - from.Comp2) / 2),
      dimred_object$space_lines %>% filter(directed),
      size = line_size, colour = "#444444",
      arrow = arrow(length = arrow_length, type = "open")
    ) +
    geom_segment(
      aes(x = from.Comp1, xend = to.Comp1, y = from.Comp2, yend = to.Comp2),
      dimred_object$space_lines,
      size = line_size, colour = "#444444"
    ) +
    geom_point(
      aes(Comp1, Comp2, colour = colour),
      dimred_object$space_samples,
      size = 3
    ) +
    ggrepel::geom_label_repel(
      aes(Comp1, Comp2, label = milestone_id, fill = colour),
      dimred_object$space_milestones %>% filter(milestone_id %in% nodes_to_label)
    ) +
    scale_colour_identity() +
    scale_fill_identity()

  if (plot_milestones) {
    g <- g +
      geom_point(
        aes(Comp1, Comp2, colour = colour, fill = colour),
        dimred_object$space_milestones,
        size = 5, shape = 4, stroke = 2
      )
  }

  process_dynplot(g, object$id)
}

#' Plot a dimensionality reduced trajectory
#'
#' @param original_object output as generated by \code{\link{dimred_trajectory}} or \code{\link[dynwrap]{wrap_data}}
#' @param new_object output as generated by \code{\link{dimred_trajectory}} or \code{\link[dynwrap]{wrap_data}}
#' @param insert_phantom_edges attempt to plot bifurcating edges correctly automatically
#'
#' @importFrom grid arrow
#' @importFrom cowplot theme_cowplot
#'
#' @export
plot_combined <- function(original_object, new_object, insert_phantom_edges = TRUE) {
  original_dimred <- check_or_perform_dimred(original_object, insert_phantom_edges)
  new_dimred <- check_or_perform_dimred(new_object, insert_phantom_edges)

  combined_dimred <- new_dimred
  combined_dimred$space_samples$colour <- original_dimred$space_samples$colour

  g <- with(combined_dimred, {
    segment_aes <- aes(x = from.Comp1, xend = to.Comp1, y = from.Comp2, yend = to.Comp2)
    ggplot() +
      geom_segment(segment_aes, size = 8, colour = "#444444",
                   space_lines %>% filter(directed),
                   arrow = arrow(length = unit(1, "cm"))) +
      geom_segment(segment_aes, size = 8, colour = "#444444", space_lines %>% filter(!directed)) +
      geom_point(aes(Comp1, Comp2, colour = colour), space_samples, size = 3) +
      scale_colour_identity() +
      scale_fill_identity()
  })

  process_dynplot(g, paste0(original_object$id, " vs. ", new_object$id))
}
