#' Default theme for TI plots
#'
#' @param g A ggplot to modify
#' @param id The title
#' @param expand Whether or not to leave space at the borders
#'
#' @export
process_dynplot <- function(g, id, expand = TRUE) {
  ranges <- ggplot_build(g)$layout$panel_ranges[[1]]
  yrange <- ranges$y.range
  xrange <- ranges$x.range

  xdiff <- diff(xrange)
  ydiff <- diff(yrange)
  maxdiff <- max(xdiff, ydiff)
  new_xrange <- mean(xrange) + c(-maxdiff/2, maxdiff/2)
  new_yrange <- mean(yrange) + c(-maxdiff/2, maxdiff/2)
  new_xrange2 <- mean(xrange) + c(-maxdiff, maxdiff)
  new_yrange2 <- mean(yrange) + c(-maxdiff, maxdiff)

  g +
    theme(
      plot.title = element_text(size = 20, face = "bold", hjust = .5),
      panel.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      panel.border = element_rect(colour = "black", fill=NA),
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      legend.key = element_blank()
    ) +
    ggtitle(id) +
    coord_equal(expand = expand, xlim = new_xrange, ylim = new_yrange) +
    xlim(new_xrange2[[1]], new_xrange2[[2]]) + ylim(new_yrange2[[1]], new_yrange2[[2]]) +
    expand_limits(x = new_xrange, y = new_yrange)
}

#' Plot a dimensionality reduced trajectory
#'
#' @inheritParams check_or_perform_dimred
#' @param transition_size The size of the transition lines between milestones.
#' @param cell_size The size of cells.
#' @param milestone_size The size of milestones.
#' @param arrow_length length of the arrow.
#' @param plot_label What to label. Must be one of \code{"leaves"}, \code{"all"}, or \code{"none"}.
#' @param plot_milestones Whether to plot the milestones.
#'
#' @importFrom grid arrow unit
#' @importFrom ggrepel geom_label_repel
#'
#' @export
plot_default <- function(
  object,
  colour_cells = "milestone",
  colour_milestones = "auto",
  transition_size = 8,
  cell_size = 3,
  milestone_size = 5,
  arrow_length = grid::unit(1, "cm"),
  plot_label = c("leaves", "all", "none"),
  plot_milestones = TRUE
) {
  # check whether object has already been graph-dimredded
  dimred_object <- check_or_perform_dimred(
    object,
    colour_cells = colour_cells,
    colour_milestones = colour_milestones
  )

  # check and process label
  plot_label <- match.arg(plot_label)
  nodes_to_label <-
    if (plot_label == "leaves") {
      dimred_object$space_lines %>% {c(setdiff(.$from, .$to), setdiff(.$to, .$from))}
    } else if (plot_label == "all") {
      dimred_object$space_milestones$milestone_id
    } else if (plot_label == "none"){
      c()
    } else {
      stop(sQuote("plot_label"), " should be one of: \"leaves\", \"all\", or \"none\"")
    }

  # make plot
  g <-
    ggplot() +
    theme(legend.position = "none") +
    geom_segment(
      aes(x = from.Comp1, xend = from.Comp1 + (to.Comp1 - from.Comp1) / 2, y = from.Comp2, yend = from.Comp2 + (to.Comp2 - from.Comp2) / 2),
      dimred_object$space_lines %>% filter(directed),
      size = transition_size, colour = "#444444",
      arrow = arrow(length = arrow_length, type = "open")
    ) +
    geom_segment(
      aes(x = from.Comp1, xend = to.Comp1, y = from.Comp2, yend = to.Comp2),
      dimred_object$space_lines,
      size = transition_size, colour = "#444444"
    ) +
    geom_point(
      aes(Comp1, Comp2, colour = colour),
      dimred_object$space_samples,
      size = cell_size
    ) +
    ggrepel::geom_label_repel(
      aes(Comp1, Comp2, label = milestone_id, fill = colour),
      dimred_object$space_milestones %>% filter(milestone_id %in% nodes_to_label)
    ) +
    scale_colour_identity() +
    scale_fill_identity()

  if (plot_milestones) {
    g <- g +
      geom_point(
        aes(Comp1, Comp2, colour = colour, fill = colour),
        dimred_object$space_milestones,
        size = milestone_size, shape = 4, stroke = 2
      )
  }

  process_dynplot(g, object$id)
}

#' Plot a dimensionality reduced trajectory
#'
#' @param original_object An object generated by \code{wrap_data} or \code{dimred_trajectory}.
#' @param new_object An object generated by \code{wrap_data} or \code{dimred_trajectory}.
#' @inheritParams plot_default
#'
#' @export
plot_combined <- inherit_default_params(
  list(plot_default),
  function(
    original_object,
    new_object,
    transition_size,
    cell_size,
    milestone_size,
    arrow_length,
    plot_label,
    plot_milestones
  ) {
    original_dimred <- check_or_perform_dimred(original_object)
    new_dimred <- check_or_perform_dimred(new_object)

    colour_milestones <- original_dimred$space_milestones %$%
      set_names(colour, milestone_id)
    colour_cells <- original_dimred$space_samples %$%
      set_names(colour, cell_id)

    plot_default(
      new_dimred,
      colour_milestones = colour_milestones,
      colour_cells = colour_cells,
      transition_size = transition_size,
      cell_size = cell_size,
      milestone_size = milestone_size,
      arrow_length = arrow_length,
      plot_label = plot_label,
      plot_milestones = plot_milestones
    ) +
      ggtitle(paste0(original_object$id, " vs. ", new_object$id))
  }
)
