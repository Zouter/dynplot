#' Default theme for TI plots
#'
#' @param g A ggplot to modify
#' @param id The title
#' @param expand Whether or not to leave space at the borders
#'
#' @export
process_dynplot <- function(g, id, expand = TRUE) {
  ranges <- ggplot_build(g)$layout$panel_ranges[[1]]
  yrange <- ranges$y.range
  xrange <- ranges$x.range

  xdiff <- diff(xrange)
  ydiff <- diff(yrange)
  maxdiff <- max(xdiff, ydiff)
  new_xrange <- mean(xrange) + c(-maxdiff/2, maxdiff/2)
  new_yrange <- mean(yrange) + c(-maxdiff/2, maxdiff/2)
  new_xrange2 <- mean(xrange) + c(-maxdiff, maxdiff)
  new_yrange2 <- mean(yrange) + c(-maxdiff, maxdiff)

  g +
    theme(
      plot.title = element_text(size = 20, face = "bold", hjust = .5),
      panel.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      panel.border = element_rect(colour = "black", fill=NA),
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      legend.key = element_blank()
    ) +
    ggtitle(id) +
    coord_equal(expand = expand, xlim = new_xrange, ylim = new_yrange) +
    xlim(new_xrange2[[1]], new_xrange2[[2]]) + ylim(new_yrange2[[1]], new_yrange2[[2]]) +
    expand_limits(x = new_xrange, y = new_yrange)
}

#' Plot a dimensionality reduced trajectory
#'
#' @param object output as generated by \code{\link{dimred_trajectory}} or \code{\link[dynwrap]{wrap_data}}
#' @param insert_phantom_edges attempt to plot bifurcating edges correctly automatically
#' @param line_size size of the line
#'
#' @importFrom grid arrow
#' @importFrom cowplot theme_cowplot
#'
#' @export
plot_default <- function(object, insert_phantom_edges = TRUE, line_size = 8, arrow_length = unit(1, "cm"), label="leaves", plot_milestones = TRUE) {
  dimred_object <- check_or_perform_dimred(object, insert_phantom_edges)

  if (label == "leaves") {
    nodes_to_label <- dimred_object$space_lines %>% {c(setdiff(.$from, .$to), setdiff(.$to, .$from))}
  } else if (label == "all") {
    nodes_to_label <- dimred_object$space_milestones$milestone_id
  } else {
    nodes_to_label <- c()
  }

  g <- with(dimred_object, {
    segment_aes <- aes(x = from.Comp1, xend = to.Comp1, y = from.Comp2, yend = to.Comp2)
    segment_mid_aes <- aes(x = from.Comp1, xend = from.Comp1 + (to.Comp1 - from.Comp1)/2, y = from.Comp2, yend = from.Comp2 + (to.Comp2 - from.Comp2)/2)
    ggplot() +
      geom_segment(segment_mid_aes, size = line_size, colour = "#444444",
                   space_lines %>% filter(directed),
                   arrow = arrow(length = arrow_length, type = "closed")) +
      geom_segment(segment_aes, size = line_size, colour = "#444444",
                   space_lines %>% filter(directed)) +
      geom_segment(segment_aes, size = line_size, colour = "#444444", space_lines %>% filter(!directed)) +
      geom_point(aes(Comp1, Comp2, colour = colour), space_samples, size = 3) +
      geom_point(aes(Comp1, Comp2, colour = colour, fill = colour), space_milestones, size = 5, shape = 4, stroke = 2, alpha=as.numeric(plot_milestones)) +
      ggrepel::geom_label_repel(aes(Comp1, Comp2, label = milestone_id, fill=colour), space_milestones %>% filter(milestone_id %in% nodes_to_label)) +
      scale_colour_identity() +
      scale_fill_identity()
  })

  process_dynplot(g, object$id)
}

#' Plot a dimensionality reduced trajectory
#'
#' @param original_object output as generated by \code{\link{dimred_trajectory}} or \code{\link[dynwrap]{wrap_data}}
#' @param new_object output as generated by \code{\link{dimred_trajectory}} or \code{\link[dynwrap]{wrap_data}}
#' @param insert_phantom_edges attempt to plot bifurcating edges correctly automatically
#'
#' @importFrom grid arrow
#' @importFrom cowplot theme_cowplot
#'
#' @export
plot_combined <- function(original_object, new_object, insert_phantom_edges = TRUE) {
  original_dimred <- check_or_perform_dimred(original_object, insert_phantom_edges)
  new_dimred <- check_or_perform_dimred(new_object, insert_phantom_edges)

  combined_dimred <- new_dimred
  combined_dimred$space_samples$colour <- original_dimred$space_samples$colour

  g <- with(combined_dimred, {
    segment_aes <- aes(x = from.Comp1, xend = to.Comp1, y = from.Comp2, yend = to.Comp2)
    ggplot() +
      geom_segment(segment_aes, size = 8, colour = "#444444",
                   space_lines %>% filter(directed),
                   arrow = arrow(length = unit(1, "cm"))) +
      geom_segment(segment_aes, size = 8, colour = "#444444", space_lines %>% filter(!directed)) +
      geom_point(aes(Comp1, Comp2, colour = colour), space_samples, size = 3) +
      scale_colour_identity() +
      scale_fill_identity()
  })

  process_dynplot(g, paste0(original_object$id, " vs. ", new_object$id))
}
